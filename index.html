<!DOCTYPE html>
<html lang="en">
<head>
  <title>History Notes: Ch 4</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
  <link rel="icon" href="https://ssl.gstatic.com/docs/documents/images/kix-favicon7.ico">
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css" rel="stylesheet">
  <style>
    /* --- STEALTH THEME: OFFICE DOCUMENT STYLE --- */
    :root { --bg: #ffffff; --text: #333; --toolbar: #f1f3f4; --border: #dadce0; --highlight: #e8f0fe; }
    
    body { 
      font-family: Arial, sans-serif; 
      margin: 0; background: var(--bg); color: var(--text); height: 100dvh; 
      display: flex; flex-direction: column; overflow: hidden; 
    }

    .screen { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: flex; flex-direction: column; background: var(--bg); z-index: 100; }
    .hidden { display: none !important; }

    /* 1. LOGIN SCREEN */
    #auth-screen { justify-content: center; align-items: center; }
    .box { border: 1px solid #ccc; padding: 20px; border-radius: 4px; box-shadow: 0 2px 5px rgba(0,0,0,0.1); text-align: center; background: #fff;}
    h3 { margin-top: 0; color: #555; font-size: 16px; font-weight: normal;}
    input.auth { padding: 8px; border: 1px solid #ccc; width: 200px; margin-bottom: 10px; }
    button.btn { padding: 6px 15px; background: #1a73e8; color: white; border: none; border-radius: 4px; cursor: pointer; font-size: 13px; }

    /* 2. SELECTION SCREEN */
    #selection-screen { justify-content: center; align-items: center; }
    .file-list { list-style: none; padding: 0; width: 250px; border: 1px solid #ccc; }
    .file-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; display: flex; align-items: center; gap: 10px; font-size: 14px;}
    .file-item:hover { background: #f1f3f4; }
    .file-icon { color: #5f6368; }

    /* 3. INSTANT MSG SCREEN */
    #instant-screen { align-items: center; padding-top: 50px; }
    #instant-list { width: 90%; max-width: 400px; border: 1px solid #ccc; background: #fff; }
    .instant-item { padding: 15px; border-bottom: 1px solid #eee; cursor: pointer; color: #333; font-size: 14px; display: flex; gap: 10px;}
    .instant-item:hover { background: #e8f0fe; }
    .instant-item i { color: #1a73e8; width: 20px; text-align: center;}

    /* 4. CHAT SCREEN (Google Docs Look) */
    #header { 
      padding: 0 15px; border-bottom: 1px solid var(--border); background: #fff; 
      display: flex; justify-content: space-between; align-items: center; height: 50px; flex-shrink: 0;
    }
    #doc-info { line-height: 1.2; }
    #doc-title { font-size: 18px; color: #202124; display: flex; align-items: center; gap: 10px;}
    #online-status { font-size: 11px; color: #188038; background: #e6f4ea; padding: 2px 5px; border-radius: 3px; display: none;}
    #doc-menu { font-size: 12px; color: #5f6368; }
    #panic-btn { background: #d93025; color: white; border: none; padding: 5px 10px; border-radius: 4px; cursor: pointer; font-size: 12px; }

    #messages { 
      list-style: none; padding: 20px 40px; margin: 0; 
      flex-grow: 1; overflow-y: auto; display: flex; flex-direction: column; gap: 6px; 
    }
    @media (max-width: 600px) { #messages { padding: 15px; padding-bottom: 80px; } }

    .msg-container { font-size: 14px; line-height: 1.5; color: #000; position: relative; }
    .my-msg { color: #000; font-weight: bold; }
    .my-msg::before { content: "‚Ä¢ "; }
    .other-msg { color: #444; }
    .other-msg::before { content: "- "; }

    .msg-img { max-width: 150px; border: 1px solid #ccc; display: block; margin: 5px 0; }
    
    /* DOCUMENT LINK STYLE */
    .doc-link { color: #1a73e8; text-decoration: underline; cursor: pointer; font-family: monospace; }
    .doc-link:hover { color: #174ea6; }

    audio { height: 25px; margin-top: 5px; opacity: 0.8; }
    #typing-indicator { position: fixed; bottom: 50px; left: 15px; font-size: 11px; color: #999; font-style: italic; }

    #form-container { 
      position: fixed; bottom: 0; left: 0; width: 100%; padding: 8px 10px; 
      background: var(--toolbar); border-top: 1px solid var(--border); 
      display: flex; gap: 10px; align-items: center; z-index: 20;
      padding-bottom: max(10px, env(safe-area-inset-bottom)); box-sizing: border-box;
    }
    #input { flex-grow: 1; border: 1px solid #ccc; padding: 6px 10px; border-radius: 4px; outline: none; font-size: 14px; }
    .tool-btn { color: #5f6368; background: none; border: none; font-size: 16px; cursor: pointer; padding: 5px; }
    .tool-btn:hover { background: #dadce0; border-radius: 4px; }
    .recording { color: red; animation: pulse 1s infinite; }
    @keyframes pulse { 0% { opacity: 1; } 50% { opacity: 0.5; } 100% { opacity: 1; } }

    #context-menu { position: fixed; background: #fff; border: 1px solid #ccc; box-shadow: 0 4px 10px rgba(0,0,0,0.2); display: none; flex-direction: column; width: 180px; z-index: 2000; font-size: 13px; }
    .ctx-item { padding: 10px 15px; cursor: pointer; border-bottom: 1px solid #f1f3f4; display: flex; align-items: center; gap: 10px; }
    .ctx-item:hover { background: #f1f3f4; }
    .emoji-row { display: flex; justify-content: space-between; padding: 10px; border-bottom: 1px solid #eee; }
    .emoji-opt { font-size: 20px; cursor: pointer; padding: 2px; }
    .emoji-opt:hover { background: #e8f0fe; border-radius: 4px; }
    #menu-overlay { position: fixed; top: 0; left: 0; width: 100%; height: 100%; display: none; z-index: 1999; }
    .reaction-mark { font-size: 10px; vertical-align: super; color: goldenrod; margin-left: 2px; }
  </style>
</head>
<body>

  <div id="auth-screen" class="screen">
    <div class="box">
      <h3>Document Password</h3>
      <input id="secret-code" type="password" class="auth" placeholder="Enter Password" />
      <br>
      <button class="btn" onclick="checkLogin()">Unlock</button>
    </div>
  </div>

  <div id="selection-screen" class="screen hidden">
    <div class="box" style="padding: 0; border: none; box-shadow: none;">
      <h3 style="margin-bottom: 10px;">Select Action</h3>
      <ul class="file-list">
        <li class="file-item" onclick="openChat()">
          <i class="fas fa-file-alt file-icon"></i> Edit Notes (Chat)
        </li>
        <li class="file-item" onclick="openInstant()">
          <i class="fas fa-list-ul file-icon"></i> Update Log (Instant Msg)
        </li>
      </ul>
    </div>
  </div>

  <div id="instant-screen" class="screen hidden">
    <div style="width: 90%; max-width: 400px; display: flex; justify-content: space-between; margin-bottom: 10px;">
      <span style="font-weight: bold; color: #555;">Quick Actions</span>
      <button onclick="goBack()" style="background: none; border: none; color: #d93025; cursor: pointer;">Close</button>
    </div>
    <div id="instant-list">
      <div class="quick-opt" onclick="sendInstant('I am Busy in Arranging Programsüö´')"><i class="fas fa-music"></i> Busy in Programs</div>
      <div class="quick-opt" onclick="sendInstant('I am Busy in Some Other Worküö´')"><i class="far fa-frown"></i> Busy in Other Work</div>
      <div class="quick-opt" onclick="sendInstant('Studying Today üìö')"><i class="fas fa-book"></i> Studying Today</div>
      <div class="quick-opt" onclick="sendInstant('Not Feeling Good Today')"><i class="fas fa-first-aid"></i> Not Feeling Good Today</div>
      <div class="quick-opt" onclick="sendInstant('I Will Call You Todayüìû')"><i class="fas fa-phone"></i> I Will Call Today</div>
      <div class="quick-opt" onclick="sendInstant('I Will Call You Tommorrowüìû')"><i class="fas fa-phone"></i> I Will Call Tommorrow</div>
    </div>
  </div>

  <div id="chat-screen" class="screen hidden">
    <div id="header">
      <div id="doc-info">
        <div id="doc-title">
          History_Notes.docx 
          <span id="online-status">Offline</span>
        </div>
        <div id="doc-menu">File &nbsp; Edit &nbsp; View &nbsp; Tools</div>
      </div>
      <button id="panic-btn" onclick="panic()">Exit</button>
    </div>
    
    <ul id="messages"></ul>
    <div id="typing-indicator"></div>
    
    <div id="form-container">
      <label for="doc-upload" class="tool-btn" title="Insert File"><i class="fas fa-paperclip"></i></label>
      <input type="file" id="doc-upload" accept=".pdf,.doc,.docx,.txt" style="display:none" onchange="sendDoc()" />

      <label for="img-upload" class="tool-btn" title="Insert Image"><i class="far fa-image"></i></label>
      <input type="file" id="img-upload" accept="image/*" style="display:none" onchange="sendImage()" />
      
      <button id="mic-btn" class="tool-btn" title="Dictate"><i class="fas fa-microphone"></i></button>

      <input id="input" autocomplete="off" placeholder="Type..." />
      <button id="send-btn" class="tool-btn" title="Save"><i class="fas fa-check"></i></button>
    </div>
  </div>

  <div id="menu-overlay" onclick="closeMenu()"></div>
  <div id="context-menu">
    <div class="emoji-row">
      <span class="emoji-opt" onclick="react('‚ù§Ô∏è')">‚ù§Ô∏è</span>
      <span class="emoji-opt" onclick="react('üòÇ')">üòÇ</span>
      <span class="emoji-opt" onclick="react('üòÆ')">üòÆ</span>
      <span class="emoji-opt" onclick="react('üò¢')">üò¢</span>
      <span class="emoji-opt" onclick="react('üëç')">üëç</span>
    </div>
    <div class="ctx-item" onclick="startEdit()"><i class="fas fa-pen"></i> Edit Line</div>
    <div class="ctx-item" onclick="unsend()" style="color: #d93025;"><i class="fas fa-trash"></i> Delete Line</div>
  </div>

  <script src="/socket.io/socket.io.js"></script>
  <script>
    const socket = io();
    let myName = "Editor";
    let selectedMsgId = null; 
    let selectedMsgIsMine = false;
    let typingTimer;

    // --- NAVIGATION ---
    function checkLogin() {
      const code = document.getElementById('secret-code').value;
      if(code) socket.emit('join', { code, username: "Editor" });
    }

    socket.on('auth-success', () => {
      document.getElementById('auth-screen').classList.add('hidden');
      document.getElementById('selection-screen').classList.remove('hidden');
    });

    socket.on('auth-fail', () => alert("Incorrect Password"));

    function openChat() {
      document.getElementById('selection-screen').classList.add('hidden');
      document.getElementById('chat-screen').classList.remove('hidden');
      scrollToBottom();
    }
    function openInstant() {
      document.getElementById('selection-screen').classList.add('hidden');
      document.getElementById('instant-screen').classList.remove('hidden');
    }
    function goBack() {
      document.getElementById('instant-screen').classList.add('hidden');
      document.getElementById('chat-screen').classList.add('hidden');
      document.getElementById('selection-screen').classList.remove('hidden');
    }

    // --- ONLINE STATUS ---
    socket.on('update-online-users', (users) => {
      const statusBadge = document.getElementById('online-status');
      if (users.length > 1) {
        statusBadge.style.display = 'inline-block';
        statusBadge.innerText = `${users.length} Editors Active`; 
      } else {
        statusBadge.style.display = 'none';
      }
    });

    // --- INSTANT MSG ---
    function sendInstant(text) {
      socket.emit('chat message', { text: text, type: 'text' });
      alert("Log Updated: " + text);
      location.reload(); 
    }

    // --- CHAT LOGIC ---
    const messages = document.getElementById('messages');
    const input = document.getElementById('input');

    input.addEventListener("keypress", function(event) {
      if (event.key === "Enter") {
        event.preventDefault();
        document.getElementById("send-btn").click();
      }
    });

    document.getElementById('send-btn').onclick = () => {
      if (input.value.trim()) {
        socket.emit('chat message', { text: input.value, type: 'text' });
        input.value = '';
        socket.emit('stop-typing');
      }
    };

    // --- TYPING INDICATOR ---
    input.addEventListener('input', () => {
      socket.emit('typing');
      clearTimeout(typingTimer);
      typingTimer = setTimeout(() => socket.emit('stop-typing'), 1000);
    });

    socket.on('display-typing', (user) => {
      document.getElementById('typing-indicator').innerText = "Editor is typing...";
    });
    socket.on('hide-typing', () => {
      document.getElementById('typing-indicator').innerText = '';
    });

    // Panic Button
    function panic() { window.location.href = "https://www.google.com"; }
    document.addEventListener('keydown', function(event) { if (event.key === "Escape") panic(); });

    socket.on('chat message', (msg) => { addMessageToUI(msg); scrollToBottom(); });
    socket.on('load-history', (history) => { messages.innerHTML = ''; history.forEach(addMessageToUI); scrollToBottom(); });

    function scrollToBottom() { setTimeout(() => { messages.scrollTop = messages.scrollHeight; }, 50); }

    function addMessageToUI(msg) {
      const li = document.createElement('li');
      li.className = `msg-container ${msg.username === "Editor" ? 'my-msg' : 'other-msg'}`;
      li.id = msg._id;
      
      li.oncontextmenu = (e) => showMenu(e, msg._id, true); 
      let pressTimer;
      li.ontouchstart = (e) => { pressTimer = setTimeout(() => showMenu(e, msg._id, true), 500); };
      li.ontouchend = () => clearTimeout(pressTimer);

      let content = "";
      if (msg.type === 'text') {
        content += msg.text;
      } else if (msg.type === 'image') {
        const downloadName = `image_${Date.now()}.png`;
        content += `<div style="position:relative; display:inline-block">
                      <img src="${msg.text}" class="msg-img" />
                      <a href="${msg.text}" download="${downloadName}" style="font-size:10px; text-decoration:underline; color:#1a73e8; display:block">Save Image</a>
                    </div>`;
      } else if (msg.type === 'document') {
        // --- THIS IS THE DOCUMENT PART ---
        content += `<a href="${msg.text}" download="${msg.fileName}" class="doc-link">[File: ${msg.fileName}]</a>`;
      } else if (msg.type === 'audio') {
        content += `<audio controls src="${msg.text}"></audio>`;
      }

      li.innerHTML = content;

      if(msg.reactions) {
        const vals = Object.values(msg.reactions);
        if(vals.length > 0) li.innerHTML += `<span class="reaction-mark">${vals[0]}</span>`;
      }
      messages.appendChild(li);
    }

    // --- UPLOADS & VOICE ---
    function sendImage() {
      const file = document.getElementById('img-upload').files[0];
      if (!file) return;
      const reader = new FileReader();
      reader.onload = (e) => socket.emit('chat message', { text: e.target.result, type: 'image' });
      reader.readAsDataURL(file);
    }
    
    // --- SEND DOCUMENT FUNCTION ---
    function sendDoc() {
      const file = document.getElementById('doc-upload').files[0];
      if (!file) return;
      if(file.size > 10 * 1024 * 1024) return alert("File too large");
      const reader = new FileReader();
      reader.onload = (e) => socket.emit('chat message', { text: e.target.result, type: 'document', fileName: file.name });
      reader.readAsDataURL(file);
    }

    let mediaRecorder; let audioChunks = []; const micBtn = document.getElementById('mic-btn'); let isRecording = false;
    micBtn.onclick = async () => {
      if (!isRecording) {
        try {
          const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          mediaRecorder = new MediaRecorder(stream);
          mediaRecorder.start();
          isRecording = true;
          micBtn.classList.add('recording');
          audioChunks = [];
          mediaRecorder.ondataavailable = e => audioChunks.push(e.data);
          mediaRecorder.onstop = () => {
             const audioBlob = new Blob(audioChunks, { type: 'audio/webm' });
             const reader = new FileReader(); reader.readAsDataURL(audioBlob);
             reader.onloadend = () => socket.emit('chat message', { text: reader.result, type: 'audio' });
          };
        } catch(err) { alert("Mic Error"); }
      } else { mediaRecorder.stop(); isRecording = false; micBtn.classList.remove('recording'); }
    };

    // --- MENU ---
    const menu = document.getElementById('context-menu');
    const overlay = document.getElementById('menu-overlay');
    function showMenu(e, msgId, isMine) {
      e.preventDefault();
      selectedMsgId = msgId;
      let x = e.clientX; let y = e.clientY;
      menu.style.left = x + 'px'; menu.style.top = y + 'px'; menu.style.display = 'flex'; overlay.style.display = 'block';
    }
    function closeMenu() { menu.style.display = 'none'; overlay.style.display = 'none'; }
    function react(emoji) { if(selectedMsgId) socket.emit('react', { messageId: selectedMsgId, reaction: emoji }); closeMenu(); }
    function unsend() { if(selectedMsgId) socket.emit('unsend-message', selectedMsgId); closeMenu(); }
    function startEdit() { if(selectedMsgId) { const newText = prompt("Edit:"); if(newText) socket.emit('edit-message', { messageId: selectedMsgId, newText }); } closeMenu(); }

  </script>
</body>
</html>
